{% extends "base.html" %}

{% block title %}Foydalanuvchilar - FastAPI Admin{% endblock %}

{% block page_title %}
<i class="fas fa-users"></i> Foydalanuvchilar
{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="/admin/users/add" class="btn btn-success">
        <i class="fas fa-plus"></i> Yangi foydalanuvchi
    </a>
    <button type="button" class="btn btn-info" onclick="exportUsers()">
        <i class="fas fa-download"></i> Export
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Search -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="get" action="/admin/users" class="d-flex">
            <input type="text" name="search" class="form-control" placeholder="Username yoki email bo'yicha qidiring..." value="{{ search }}">
            <button type="submit" class="btn btn-primary ms-2">
                <i class="fas fa-search"></i>
            </button>
            {% if search %}
            <a href="/admin/users" class="btn btn-secondary ms-2">
                <i class="fas fa-times"></i>
            </a>
            {% endif %}
        </form>
    </div>
    <div class="col-md-6 text-end">
        <small class="text-muted">
            Jami: {{ pagination.total }} ta foydalanuvchi
        </small>
    </div>
</div>

<!-- Users Table -->
<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Ism Familiya</th>
                        <th>Holat</th>
                        <th>Superuser</th>
                        <th>Yaratilgan</th>
                        <th class="table-actions">Amallar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr id="user-{{ user.id }}">
                        <td>{{ user.id }}</td>
                        <td>
                            <strong>{{ user.username }}</strong>
                            {% if user.id == admin_user.id %}
                            <span class="badge bg-warning ms-1">Siz</span>
                            {% endif %}
                        </td>
                        <td>{{ user.email }}</td>
                        <td>
                            {% if user.first_name or user.last_name %}
                                {{ user.first_name or '' }} {{ user.last_name or '' }}
                            {% else %}
                                <em class="text-muted">Kiritilmagan</em>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_active %}
                            <span class="badge bg-success">Faol</span>
                            {% else %}
                            <span class="badge bg-danger">Nofaol</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_superuser %}
                            <i class="fas fa-crown text-warning" title="Superuser"></i>
                            {% else %}
                            <i class="fas fa-user text-muted" title="Oddiy foydalanuvchi"></i>
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ user.created_at.strftime('%d.%m.%Y %H:%M') if user.created_at else '' }}</small>
                        </td>
                        <td class="table-actions">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" onclick="viewUser({{ user.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="toggleUserActive({{ user.id }}, {{ user.is_active|lower }})" 
                                        {% if user.id == admin_user.id %}disabled{% endif %}>
                                    {% if user.is_active %}
                                    <i class="fas fa-pause"></i>
                                    {% else %}
                                    <i class="fas fa-play"></i>
                                    {% endif %}
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')" 
                                        {% if user.id == admin_user.id %}disabled{% endif %}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if pagination.total_pages > 1 %}
<nav aria-label="Sahifalash">
    <ul class="pagination justify-content-center mt-4">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="/admin/users?page={{ pagination.prev_page }}{% if search %}&search={{ search }}{% endif %}">
                <i class="fas fa-chevron-left"></i> Oldingi
            </a>
        </li>
        {% endif %}
        
        {% for page_num in range(1, pagination.total_pages + 1) %}
            {% if page_num == pagination.page %}
            <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% elif page_num <= 3 or page_num > pagination.total_pages - 3 or (page_num >= pagination.page - 2 and page_num <= pagination.page + 2) %}
            <li class="page-item">
                <a class="page-link" href="/admin/users?page={{ page_num }}{% if search %}&search={{ search }}{% endif %}">{{ page_num }}</a>
            </li>
            {% elif page_num == pagination.page - 3 or page_num == pagination.page + 3 %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="/admin/users?page={{ pagination.next_page }}{% if search %}&search={{ search }}{% endif %}">
                Keyingi <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function viewUser(userId) {
    window.location.href = `/admin/users/${userId}`;
}

function toggleUserActive(userId, isActive) {
    const action = isActive ? "deaktivlashtirish" : "aktivlashtirish";
    
    if (confirm(`Foydalanuvchini ${action}ni xohlaysizmi?`)) {
        fetch(`/admin/api/users/${userId}/toggle-active`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Sahifani yangilash
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Xatolik yuz berdi', 'danger');
            console.error('Error:', error);
        });
    }
}

function deleteUser(userId, username) {
    if (confirm(`"${username}" foydalanuvchisini o'chirishni tasdiqlaysizmi?\n\nBu amal qaytarilmaydi!`)) {
        fetch(`/admin/api/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Qatorni olib tashlash
                document.getElementById(`user-${userId}`).remove();
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Xatolik yuz berdi', 'danger');
            console.error('Error:', error);
        });
    }
}

function exportUsers() {
    // Bu yerda export funksiyasi bo'lishi mumkin
    showAlert('Export funksiyasi hali amalga oshirilmagan', 'info');
}

function openCreateUserModal() {
    console.log('openCreateUserModal called');
    const modalElement = document.getElementById('createUserModal');
    
    if (modalElement) {
        // Bootstrap 5 modal
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('Modal shown');
    } else {
        console.error('Modal element not found');
    }
}

function debugModal() {
    console.log('debugModal called');
    console.log('Bootstrap:', typeof bootstrap);
    const modalElement = document.getElementById('createUserModal');
    console.log('Modal element:', modalElement);
    
    if (modalElement && typeof bootstrap !== 'undefined') {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('Modal manually shown');
    } else {
        console.error('Modal element or Bootstrap not found');
    }
}

function createUser() {
    const form = document.getElementById('createUserForm');
    const formData = new FormData(form);
    
    fetch('/admin/api/users', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Modalni yopish
            const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
            modal.hide();
            // Formni tozalash
            form.reset();
            // Sahifani yangilash
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Xatolik yuz berdi', 'danger');
        console.error('Error:', error);
    });
}
</script>

<!-- User yaratish modali -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">
                    <i class="fas fa-user-plus"></i> Yangi foydalanuvchi yaratish
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm" onsubmit="event.preventDefault(); createUser();">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="username" name="username" required>
                                <div class="form-text">Foydalanuvchi nomi (takrorlanmasligi kerak)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required>
                                <div class="form-text">Email manzili (takrorlanmasligi kerak)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="first_name" class="form-label">Ism</label>
                                <input type="text" class="form-control" id="first_name" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="last_name" class="form-label">Familiya</label>
                                <input type="text" class="form-control" id="last_name" name="last_name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">Parol <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="password" name="password" required minlength="6">
                        <div class="form-text">Kamida 6 ta belgidan iborat bo'lishi kerak</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                <label class="form-check-label" for="is_active">
                                    Faol
                                </label>
                                <div class="form-text">Foydalanuvchi tizimga kira oladimi?</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="is_superuser" name="is_superuser">
                                <label class="form-check-label" for="is_superuser">
                                    Super foydalanuvchi
                                </label>
                                <div class="form-text">Admin paneliga kirish huquqi</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Bekor qilish
                </button>
                <button type="button" class="btn btn-success" onclick="createUser()">
                    <i class="fas fa-save"></i> Saqlash
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
