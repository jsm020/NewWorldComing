<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2FA WebSocket Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .status-box {
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .status-waiting {
            background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
            border-left: 5px solid #f39c12;
        }
        
        .status-confirmed {
            background: linear-gradient(45deg, #00b894, #00cec9);
            border-left: 5px solid #27ae60;
            color: white;
        }
        
        .status-denied {
            background: linear-gradient(45deg, #e17055, #d63031);
            border-left: 5px solid #e74c3c;
            color: white;
        }
        
        .btn-custom {
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: none;
            margin: 0 10px;
        }
        
        .btn-confirm {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .btn-confirm:hover {
            background: linear-gradient(45deg, #1e8449, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .btn-deny {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-deny:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .connection-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
        }
        
        .connected {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .disconnected {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .device-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="connection-indicator" id="connectionStatus">
        <i class="fas fa-circle"></i> Ulanmoqda...
    </div>

    <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-md-8 col-lg-6">
                <div class="card">
                    <div class="card-body p-5 text-center">
                        <div class="mb-4">
                            <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                            <h2 class="fw-bold">2FA Hybrid Tasdiqlash</h2>
                            <p class="text-muted">Telegram + WebSocket Real-time</p>
                            <div class="alert alert-info">
                                <i class="fas fa-paper-plane"></i> 
                                <strong>Telegram botga xabar yuborildi!</strong><br>
                                <small>Bu sahifada real-time tasdiqlang yoki Telegram botdagi tugmalarni bosing</small>
                            </div>
                        </div>
                        
                        <!-- User va device ma'lumotlari -->
                        <div class="device-info">
                            <h5><i class="fas fa-user"></i> {{ user.username }}</h5>
                            <p class="mb-1"><strong>IP:</strong> {{ attempt.ip_address }}</p>
                            <p class="mb-1"><strong>Vaqt:</strong> {{ attempt.created_at.strftime('%d.%m.%Y %H:%M:%S') }}</p>
                            <p class="mb-0"><strong>Qurilma:</strong> {{ attempt.user_agent[:50] }}...</p>
                        </div>
                        
                        <!-- Status display -->
                        <div id="statusBox" class="status-box status-waiting">
                            <h5 id="statusTitle">
                                <i class="fas fa-clock fa-spin"></i> 
                                2FA Hybrid Tasdiqlash
                            </h5>
                            <p id="statusMessage">
                                ‚úÖ Telegram botga xabar yuborildi<br>
                                üîó WebSocket ulanmoqda...<br>
                                ‚è≥ 2FA tasdiqlash kutilmoqda...
                            </p>
                        </div>
                        
                        <!-- Real-time status messages -->
                        <div id="realTimeStatus" class="alert alert-info mt-3" style="display: none;">
                            <div id="statusList">
                                <!-- Real-time xabarlar bu yerda ko'rinadi -->
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div id="actionButtons" class="mt-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <i class="fab fa-telegram-plane fa-2x text-primary mb-2"></i>
                                            <h6>Telegram Bot</h6>
                                            <small class="text-muted">Telegram botdagi tugmalarni bosing</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <i class="fas fa-globe fa-2x text-success mb-2"></i>
                                            <h6>Web Interface</h6>
                                            <button onclick="confirmLogin()" class="btn btn-custom btn-confirm btn-sm">
                                                <i class="fas fa-check"></i> Tasdiqlash
                                            </button>
                                            <button onclick="denyLogin()" class="btn btn-custom btn-deny btn-sm">
                                                <i class="fas fa-times"></i> Rad Etish
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auto-refresh countdown -->
                        <div class="mt-3">
                            <small class="text-muted">
                                Verification kod: <code>{{ verification_code }}</code>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const verificationCode = "{{ verification_code }}";
        const wsUrl = "{{ websocket_url }}";
        let ws = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        
        // WebSocket connection
        function connectWebSocket() {
            try {
                console.log(`üîÑ WebSocket ulanish urinishi: ${wsUrl}`);
                addStatusMessage('üîÑ WebSocket ulanmoqda...', 'info');
                addStatusMessage(`üåê URL: ${wsUrl}`, 'info');
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    console.log('‚úÖ WebSocket muvaffaqiyatli ulandi');
                    reconnectAttempts = 0; // Reset counter
                    updateConnectionStatus(true);
                    addStatusMessage('‚úÖ WebSocket real-time ulandi', 'success');
                    addStatusMessage('üì± Telegram botdan yoki web interfeydan tasdiqlang', 'info');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    console.log('üì® WebSocket xabar:', data);
                    handleWebSocketMessage(data);
                    
                    // Real-time xabar qo'shish
                    if (data.type === 'connected') {
                        addStatusMessage('üîó Real-time aloqa o\'rnatildi', 'success');
                    } else if (data.type === 'waiting') {
                        addStatusMessage('‚è≥ Telegram yoki web interfeydan javob kutilmoqda...', 'warning');
                    }
                };
                
                ws.onclose = function(event) {
                    console.log('‚ùå WebSocket uzildi:', event.code, event.reason);
                    updateConnectionStatus(false);
                    addStatusMessage(`‚ùå WebSocket uzildi (${event.code}: ${event.reason})`, 'danger');
                    
                    // Agar intentional yopilmagan bo'lsa va retry limit ga yetmagan bo'lsa
                    if (event.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * reconnectAttempts, 10000); // Max 10 sekund
                        console.log(`üîÑ ${delay/1000} soniyadan so'ng qayta ulanish (${reconnectAttempts}/${maxReconnectAttempts})`);
                        addStatusMessage(`üîÑ ${delay/1000} soniyadan so'ng qayta ulanish (${reconnectAttempts}/${maxReconnectAttempts})...`, 'warning');
                        setTimeout(connectWebSocket, delay);
                    } else if (reconnectAttempts >= maxReconnectAttempts) {
                        console.error('‚ùå WebSocket qayta ulanish imkoni tugadi');
                        updateConnectionStatus(false, true);
                        addStatusMessage('‚ùå WebSocket ulanish imkoni tugadi', 'danger');
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('‚ùå WebSocket xatolik:', error);
                    updateConnectionStatus(false);
                    addStatusMessage('‚ùå WebSocket ulanish xatoligi', 'danger');
                };
                
                // Connection timeout
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        console.error('‚ùå WebSocket ulanish timeout');
                        addStatusMessage('‚ùå WebSocket ulanish vaqti tugadi', 'danger');
                        ws.close();
                    }
                }, 10000); // 10 sekund timeout
                
            } catch (error) {
                console.error('‚ùå WebSocket yaratishda xatolik:', error);
                updateConnectionStatus(false);
                addStatusMessage(`‚ùå WebSocket yaratish xatoligi: ${error.message}`, 'danger');
                
                // Retry connection
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 3000);
                }
            }
        }
        
        function updateConnectionStatus(connected, failed = false) {
            const indicator = document.getElementById('connectionStatus');
            if (connected) {
                indicator.className = 'connection-indicator connected';
                indicator.innerHTML = '<i class="fas fa-circle"></i> Real-time faol';
            } else if (failed) {
                indicator.className = 'connection-indicator disconnected';
                indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ulanish xatoligi';
            } else {
                indicator.className = 'connection-indicator disconnected pulse';
                indicator.innerHTML = '<i class="fas fa-circle"></i> Qayta ulanmoqda...';
            }
        }
        
        function addStatusMessage(message, type = 'info') {
            const statusContainer = document.getElementById('realTimeStatus');
            const statusList = document.getElementById('statusList');
            
            // Show container if hidden
            statusContainer.style.display = 'block';
            
            // Create new status message
            const timestamp = new Date().toLocaleTimeString();
            const messageElement = document.createElement('div');
            messageElement.className = `d-flex align-items-center mb-2 text-${type}`;
            messageElement.innerHTML = `
                <small class="text-muted me-2">${timestamp}</small>
                <span>${message}</span>
            `;
            
            // Add to top of list
            statusList.insertBefore(messageElement, statusList.firstChild);
            
            // Limit to 5 messages
            while (statusList.children.length > 5) {
                statusList.removeChild(statusList.lastChild);
            }
            
            // Auto-scroll to top
            statusContainer.scrollTop = 0;
        }
        
        function handleWebSocketMessage(data) {
            const statusBox = document.getElementById('statusBox');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const actionButtons = document.getElementById('actionButtons');
            
            switch(data.type) {
                case 'connected':
                    statusTitle.innerHTML = '<i class="fas fa-wifi"></i> Real-time Aloqa Faol';
                    statusMessage.innerHTML = `
                        ‚úÖ Telegram botga xabar yuborildi<br>
                        üîó WebSocket real-time ulandi<br>
                        üì± Bot yoki web interfeydan tasdiqlang
                    `;
                    addStatusMessage('üîó Server bilan real-time aloqa o\'rnatildi', 'success');
                    addStatusMessage('üì± Telegram bot yoki web interfeydan tasdiqlang', 'info');
                    break;
                    
                case 'waiting':
                    statusBox.className = 'status-box status-waiting pulse';
                    statusTitle.innerHTML = '<i class="fas fa-clock fa-spin"></i> Kutilmoqda...';
                    statusMessage.textContent = data.message || '‚è≥ Telegram yoki web interfeydan javob kutilmoqda...';
                    addStatusMessage('‚è≥ Hali javob berilmagan', 'warning');
                    break;
                    
                case 'confirmed':
                    statusBox.className = 'status-box status-confirmed';
                    statusTitle.innerHTML = '<i class="fas fa-check-circle"></i> Tasdiqlandi!';
                    statusMessage.textContent = data.message || '‚úÖ Login muvaffaqiyatli tasdiqlandi';
                    actionButtons.style.display = 'none';
                    addStatusMessage('‚úÖ Login tasdiqlandi - dashboard ga yo\'naltirilmoqda...', 'success');
                    
                    // Redirect after 2 seconds
                    setTimeout(() => {
                        window.location.href = data.redirect || '/admin/dashboard';
                    }, 2000);
                    break;
                    
                case 'denied':
                    statusBox.className = 'status-box status-denied';
                    statusTitle.innerHTML = '<i class="fas fa-ban"></i> Rad Etildi!';
                    statusMessage.textContent = data.message || '‚ùå Login rad etildi va qurilma bloklandi';
                    actionButtons.style.display = 'none';
                    addStatusMessage('‚ùå Login rad etildi - qurilma bloklandi', 'danger');
                    
                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = data.redirect || '/admin/login';
                    }, 3000);
                    break;
                    
                case 'expired':
                    statusBox.className = 'status-box status-denied';
                    statusTitle.innerHTML = '<i class="fas fa-hourglass-end"></i> Muddati Tugadi';
                    statusMessage.textContent = data.message || '‚è∞ Verification vaqti tugadi';
                    actionButtons.style.display = 'none';
                    addStatusMessage('‚è∞ Verification muddati tugadi', 'danger');
                    
                    setTimeout(() => {
                        window.location.href = data.redirect || '/admin/login';
                    }, 3000);
                    break;
                    
                default:
                    console.log('Noma\'lum WebSocket xabar turi:', data.type);
                    addStatusMessage(`üì® ${data.message || 'Yangi xabar keldi'}`, 'info');
            }
        }
        
        async function confirmLogin() {
            try {
                const response = await fetch(`/admin/2fa/confirm/${verificationCode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Login confirmed successfully');
                } else {
                    alert('Xatolik: ' + result.message);
                }
                
            } catch (error) {
                console.error('Confirm error:', error);
                alert('Tasdiqlashda xatolik yuz berdi');
            }
        }
        
        async function denyLogin() {
            if (!confirm('Haqiqatan ham login ni rad etmoqchimisiz? Bu qurilma bloklanadi.')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/2fa/deny/${verificationCode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Login denied successfully');
                } else {
                    alert('Xatolik: ' + result.message);
                }
                
            } catch (error) {
                console.error('Deny error:', error);
                alert('Rad etishda xatolik yuz berdi');
            }
        }
        
        // Initialize WebSocket connection
        document.addEventListener('DOMContentLoaded', function() {
            // Dastlabki status xabarlar
            addStatusMessage('üöÄ 2FA sahifa yuklandi', 'success');
            addStatusMessage('üìß Telegram botga login xabari yuborildi', 'info');
            
            // WebSocket ulanish
            connectWebSocket();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
